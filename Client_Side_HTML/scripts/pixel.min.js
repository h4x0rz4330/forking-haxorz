var Pixel=function(t,i){this.settings={w:5,trace:.1,addClass:!0,aClass:["_top","_right","_bottom","_left"],wave:{w:10,speed:5},preload:!1},this.img={},this.canvas,this.ctx,this.aPixels=[],this.iCell=0,this.iRow=0,this.bRuning=!1,this.wave={x:0,y:0,r:0,w:0,s:0},this.aWaves=[],Pixel.prototype.init=function(){this.getSettings(),this.buildCanvas(),this.buildPixels(),this.drawImg(),this.settings.preload&&this.getColors(),this.img.o.style.display="none"},Pixel.prototype.getSettings=function(){for(var s in i)this.settings[s]=i[s];this.img={o:t,sw:t.naturalWidth,sh:t.naturalHeight,h:t.height,w:t.width,x:t.offsetLeft,y:t.offsetTop},this.wave.w=-this.settings.wave.w,this.wave.s=this.settings.wave.speed},Pixel.prototype.buildCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.img.w,this.canvas.height=this.img.h,this.ctx=this.canvas.getContext("2d"),this.img.o.parentNode.appendChild(this.canvas),this.bindEvent()},Pixel.prototype.buildPixels=function(){this.iCell=Math.floor(this.img.w/this.settings.w),this.iRow=Math.floor(this.img.h/this.settings.w),this.aPixels=[];for(var t=0;t<=this.iRow;t++){this.aPixels[t]=[];for(var i=0;i<=this.iCell;i++)this.aPixels[t][i]={x:i*this.settings.w,y:t*this.settings.w,c:!1,a:1}}},Pixel.prototype.getColors=function(){for(var t=0;t<=this.iRow;t++)for(var i=0;i<=this.iCell;i++)this.aPixels[t][i].c||(this.aPixels[t][i].c=this.getColor(this.aPixels[t][i]))},Pixel.prototype.getColor=function(t){for(var i=this.ctx.getImageData(t.x,t.y,this.settings.w,this.settings.w).data,s={r:0,g:0,b:0},e=0,a=0;(e+=4*this.settings.w)<i.length;)++a,s.r+=i[e],s.g+=i[e+1],s.b+=i[e+2];return s.r=~~(s.r/a),s.g=~~(s.g/a),s.b=~~(s.b/a),s},Pixel.prototype.bindEvent=function(){this.enter=this.launch.bind(this),this.canvas.addEventListener("mouseenter",this.enter),this.remove=this.out.bind(this),this.canvas.addEventListener("mouseleave",this.remove),this.move=this.updateDir.bind(this),this.canvas.addEventListener("mousemove",this.move),this.click=this.addWave.bind(this),this.canvas.addEventListener("click",this.click)},Pixel.prototype.clearEvent=function(){this.canvas.removeEventListener("mouseenter",this.enter),this.canvas.removeEventListener("mouseleave",this.remove),this.canvas.removeEventListener("mousemove",this.move),this.canvas.removeEventListener("click",this.click)},Pixel.prototype.launch=function(){this.settings.addClass&&this.updateClass(),this.bRuning||(this.bRuning=!0,this.run())},Pixel.prototype.out=function(){this.dir=-1,this.removeClass()},Pixel.prototype.stop=function(){this.bRuning=!1},Pixel.prototype.run=function(t){if(this.update(),this.drawWave(),this.bRuning){var i=this.run.bind(this);requestAnimationFrame(i)}},Pixel.prototype.updateDir=function(){var t=this.getDir(event);this.dir!=t&&(this.dir=t,this.settings.addClass&&this.updateClass(),this.getAnim(),this.bRuning||this.launch())},Pixel.prototype.getDir=function(t){var i=this.canvas.getBoundingClientRect(),s=i.left+this.img.w/2,e=i.top+this.img.h/2,a=(t.pageX-s)*(this.img.w>this.img.h?this.img.h/this.img.w:1),h=-(t.pageY-e)*(this.img.h>this.img.w?this.img.w/this.img.h:1),n=Math.round((Math.atan2(a,h)+Math.PI)/(Math.PI/2)+2)%4;return n},Pixel.prototype.updateClass=function(){this.removeClass(),"undefined"!=typeof this.settings.aClass[this.dir]&&this.canvas.parentNode.classList.add(this.settings.aClass[this.dir])},Pixel.prototype.removeClass=function(){for(var t=0;t<this.settings.aClass.length;t++)this.canvas.parentNode.classList.remove(this.settings.aClass[t])},Pixel.prototype.checkWaves=function(t,i){for(var s=!1,e=this.aWaves.length-1;e>=0;e--)this.checkWave(t,i,this.aWaves[e].x,this.aWaves[e].y,this.aWaves[e].r)&&!this.checkWave(t,i,this.aWaves[e].x,this.aWaves[e].y,this.aWaves[e].w)&&(s=!0);return s},Pixel.prototype.checkWave=function(t,i,s,e,a){var h=Math.abs(s-t-this.settings.w/2),n=Math.abs(e-i-this.settings.w/2);if(h>this.settings.w/2+a)return!1;if(n>this.settings.w/2+a)return!1;if(h<=this.settings.w/2)return!0;if(n<=this.settings.w/2)return!0;var o=h-this.settings.w/2,r=n-this.settings.w/2;return a*a>=o*o+r*r},Pixel.prototype.addWave=function(){this.animFromClick(event),this.bRuning||this.launch()},Pixel.prototype.updateWave=function(t){this.aWaves[t].r+=this.aWaves[t].s,this.aWaves[t].w+=this.aWaves[t].s,this.aWaves[t].w>this.aWaves[t].end&&this.aWaves.splice(t,1)},Pixel.prototype.update=function(){for(var t=this.aWaves.length-1;t>=0;t--)this.updateWave(t);0==this.aWaves.length&&this.stop()},Pixel.prototype.getAnim=function(){switch(this.dir){case 0:this.animFromT();break;case 1:this.animFromR();break;case 2:this.animFromB();break;case 3:this.animFromL()}},Pixel.prototype.animFromT=function(){var t={x:this.canvas.width/2,y:0,r:0,w:this.wave.w,s:this.wave.s,end:1.3*this.canvas.height};this.aWaves.push(t)},Pixel.prototype.animFromR=function(){var t={x:this.canvas.width,y:this.canvas.height/2,r:0,w:this.wave.w,s:this.wave.s,end:1.3*this.canvas.width};this.aWaves.push(t)},Pixel.prototype.animFromB=function(){var t={x:this.canvas.width/2,y:this.canvas.height,r:0,w:this.wave.w,s:this.wave.s,end:1.3*this.canvas.height};this.aWaves.push(t)},Pixel.prototype.animFromL=function(){var t={x:0,y:this.canvas.height/2,r:0,w:this.wave.w,s:this.wave.s,end:1.3*this.canvas.width};this.aWaves.push(t)},Pixel.prototype.animFromClick=function(t){var i={x:t.layerX,y:t.layerY,r:0,w:this.wave.w,s:this.wave.s,end:1.3*this.canvas.width};this.aWaves.push(i)},Pixel.prototype.drawWave=function(){this.ctx.globalAlpha=this.settings.trace,this.drawImg(),this.ctx.globalAlpha=1;for(var t=0;t<=this.iRow;t++)for(var i=0;i<=this.iCell;i++){var s=this.aPixels[t][i];this.checkWaves(s.x,s.y)&&this.drawPixel(t,i)}},Pixel.prototype.drawAll=function(){this.drawImg(),this.drawAllPixel()},Pixel.prototype.drawImg=function(){this.ctx.drawImage(this.img.o,0,0,this.img.sw,this.img.sh,this.img.x,this.img.y,this.img.w,this.img.h)},Pixel.prototype.drawAllPixel=function(){for(var t=0;t<=this.iRow;t++)for(var i=0;i<=this.iCell;i++)this.drawPixel(t,i)},Pixel.prototype.drawPixel=function(t,i){this.aPixels[t][i].c||(this.aPixels[t][i].c=this.getColor(this.aPixels[t][i])),this.ctx.fillStyle="rgba( "+this.aPixels[t][i].c.r+", "+this.aPixels[t][i].c.g+", "+this.aPixels[t][i].c.b+", "+this.aPixels[t][i].a+" )",this.ctx.fillRect(this.aPixels[t][i].x,this.aPixels[t][i].y,this.settings.w,this.settings.w)},this.init()};